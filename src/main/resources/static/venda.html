<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Executar Venda</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .form-wrapper {
      background: #fff;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <section class="form-section">
    <div class="form-wrapper">
      <h3 class="mb-4 text-center">Executar Venda</h3>
      <form id="compra-form" novalidate>
        <!-- Campo para o ID do cliente -->
        <div class="mb-3">
          <label for="clienteId" class="form-label">ID do Cliente (UUID)</label>
          <input
            type="text"
            class="form-control"
            id="clienteId"
            placeholder="Cole o ID do cliente aqui"
            required
          />
        </div>

        <!-- Container onde vão os selects+quantidade -->
        <div id="itens-container" class="mb-3"></div>

        <!-- Botão para adicionar mais itens -->
        <button
          type="button"
          id="add-item"
          class="btn btn-sm btn-secondary mb-3"
        >
          <i class="bi bi-plus-circle"></i> Adicionar Item
        </button>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            Finalizar Venda
          </button>
        </div>
      </form>

      <pre id="resultado" class="mt-4 text-break"></pre>
    </div>
  </section>

  <script>
    // Autenticação HTTP Basic (substitua pelos dados reais)
    const AUTH_HEADER = 'Basic ' + btoa('fulano@exemplo.com:senha123');

    // Cria uma nova linha de item (select + quantidade + botão remover)
    function novaLinha() {
      const row = document.createElement('div');
      row.className = 'item-row d-flex gap-2 mb-2';

      const sel = document.createElement('select');
      sel.className = 'form-select produto-select';
      sel.required = true;

      const qty = document.createElement('input');
      qty.type = 'number';
      qty.min = 1;
      qty.value = 1;
      qty.className = 'form-control quantidade-input';

      const btnRem = document.createElement('button');
      btnRem.type = 'button';
      btnRem.className = 'btn btn-outline-danger';
      btnRem.innerHTML = '<i class="bi bi-dash-circle"></i>';
      btnRem.addEventListener('click', () => row.remove());

      row.append(sel, qty, btnRem);
      document.getElementById('itens-container').append(row);

      // Busca os doces e popula o select
      fetch('http://localhost:8080/doces', {
        headers: { 'Authorization': AUTH_HEADER }
      })
      .then(r => r.json())
      .then(produtos => {
        sel.innerHTML = '';
        produtos.forEach(p => {
          const o = document.createElement('option');
          o.value = p.id;
          o.textContent = `${p.nome} (R$ ${p.preco.toFixed(2)})`;
          sel.append(o);
        });
      });
    }

    // Adiciona primeira linha e configura botão
    document.getElementById('add-item').addEventListener('click', novaLinha);
    novaLinha();

    // Quando o form for enviado
    document.getElementById('compra-form').addEventListener('submit', async e => {
      e.preventDefault();
      const clienteId = document.getElementById('clienteId').value.trim();
      if (!clienteId) {
        return alert('Informe o ID do cliente');
      }

      // Lê somente as linhas de item dentro do container
      const itens = Array.from(
        document.querySelectorAll('#itens-container > .item-row')
      ).map(row => ({
        produtoId: +row.querySelector('.produto-select').value,
        quantidade: +row.querySelector('.quantidade-input').value
      }));

      const payload = { clienteId, itens };

      try {
        const res = await fetch('http://localhost:8080/compras', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': AUTH_HEADER
          },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        if (res.ok) {
          const data = JSON.parse(txt);
          document.getElementById('resultado').textContent =
            `Compra registrada! ID: ${data.id}\n` +
            JSON.stringify(data, null, 2);
        } else {
          document.getElementById('resultado').textContent =
            `Erro ${res.status}: ${txt}`;
        }
      } catch (err) {
        document.getElementById('resultado').textContent =
          `Falha na requisição: ${err}`;
      }
    });
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>

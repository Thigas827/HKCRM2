<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Executar Venda</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h3 class="mb-4 text-center">Registrar Cliente & Compra</h3>
    <form id="venda-form" novalidate>
      <!-- 1) Dados do Cliente -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input type="text" id="clienteNome" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">E-mail</label>
          <input type="email" id="clienteEmail" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">CPF</label>
          <input type="text" id="clienteCpf" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Telefone</label>
          <input type="text" id="clienteTel" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Data Nasc.</label>
          <input type="date" id="clienteNasc" class="form-control">
        </div>
      </div>

      <!-- 2) Itens da Compra -->
      <div id="itens-container" class="mb-3"></div>
      <button type="button" id="add-item" class="btn btn-sm btn-secondary mb-4">
        <i class="bi bi-plus-circle"></i> Adicionar Item
      </button>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">
          Registrar Venda
        </button>
      </div>
    </form>

    <pre id="resultado" class="mt-4"></pre>
  </div>

  <script>
    const AUTH_HEADER = 'Basic ' + btoa('funcionario@exemplo.com:senha123');

    // 1) Cria linhas de item
    function novaLinha() {
      const row = document.createElement('div');
      row.className = 'item-row d-flex gap-2 mb-2';

      const select = document.createElement('select');
      select.className = 'form-select produto-select';
      select.required = true;

      const qty = document.createElement('input');
      qty.type = 'number'; qty.min = 1; qty.value = 1;
      qty.className = 'form-control quantidade-input';

      const btnRem = document.createElement('button');
      btnRem.type = 'button'; btnRem.className = 'btn btn-outline-danger';
      btnRem.innerHTML = '<i class="bi bi-dash-circle"></i>';
      btnRem.onclick = () => row.remove();

      row.append(select, qty, btnRem);
      document.getElementById('itens-container').append(row);

      // popular produtos
      fetch('http://localhost:8080/doces', {
        headers: { 'Authorization': AUTH_HEADER }
      })
      .then(r => r.json())
      .then(produtos => {
        select.innerHTML = '';
        produtos.forEach(p => {
          const o = document.createElement('option');
          o.value = p.id;
          o.textContent = `${p.nome} (R$ ${p.preco.toFixed(2)})`;
          select.append(o);
        });
      });
    }

    document.getElementById('add-item').addEventListener('click', novaLinha);
    novaLinha();

    // 2) Submit: cria cliente, depois compra
    document.getElementById('venda-form').addEventListener('submit', async e => {
      e.preventDefault();
      const resDisplay = document.getElementById('resultado');
      resDisplay.textContent = '';

      // --- 2.1) Monta dados do cliente ---
      const cliente = {
        nome:   document.getElementById('clienteNome').value,
        email:  document.getElementById('clienteEmail').value,
        senha:  'Temp123!',                    // você pode gerar/solicitar senha
        cpf:    document.getElementById('clienteCpf').value,
        telefone: document.getElementById('clienteTel').value,
        dataNascimento: document.getElementById('clienteNasc').value
      };

      try {
        // 2.2) Cria o cliente
        const rc = await fetch('http://localhost:8080/usuarios/criar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': AUTH_HEADER
          },
          body: JSON.stringify(cliente)
        });
        if (!rc.ok) throw new Error('Erro ao criar cliente: ' + await rc.text());
        const clienteCriado = await rc.json();

        // 2.3) Monta itens
        const itens = Array.from(
          document.querySelectorAll('#itens-container > .item-row')
        ).map(row => ({
          produtoId: +row.querySelector('.produto-select').value,
          quantidade: +row.querySelector('.quantidade-input').value
        }));

        // 2.4) Registra a compra
        const rp = await fetch('http://localhost:8080/compras', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': AUTH_HEADER
          },
          body: JSON.stringify({
            clienteId: clienteCriado.id,
            itens
          })
        });
        if (!rp.ok) throw new Error('Erro ao criar compra: ' + await rp.text());
        const compra = await rp.json();

        resDisplay.textContent =
          `✅ Cliente ${clienteCriado.id} e Compra ${compra.id} registrados!\n` +
          JSON.stringify({ cliente: clienteCriado, compra }, null, 2);
      } catch (err) {
        resDisplay.textContent = err.message;
      }
    });
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>

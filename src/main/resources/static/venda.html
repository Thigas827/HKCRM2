<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Executar Venda</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    /* seu CSS de antes… */
  </style>
</head>
<body>
  <section class="form-section">
    <div class="form-wrapper">
      <h3 class="mb-4 text-center">Executar Venda</h3>
      <form id="compra-form" novalidate>
        <div class="mb-3">
          <label for="clienteId" class="form-label">Cliente ID (UUID)</label>
          <input type="text" class="form-control" id="clienteId" placeholder="UUID do cliente" required>
        </div>

        <div id="itens-container" class="mb-3">
          <!-- Linhas de item serão inseridas por JS -->
        </div>
        <button type="button" id="add-item" class="btn btn-sm btn-secondary mb-3">
          <i class="bi bi-plus-circle"></i> Adicionar Item
        </button>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">Finalizar Venda</button>
        </div>
      </form>
      <pre id="resultado" class="mt-4 text-break"></pre>
    </div>
  </section>

  <script>
  // coloque aqui o usuário e senha válidos (ou o token JWT se migrar depois)
  const AUTH_HEADER = 'Basic ' + btoa('fulano@exemplo.com:senha123');

  // Função para criar uma nova linha de item
  function novaLinha() {
    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2';

    // select de produtos
    const sel = document.createElement('select');
    sel.className = 'form-select produto-select';
    sel.required = true;

    // input de quantidade
    const qty = document.createElement('input');
    qty.type = 'number';
    qty.min = 1;
    qty.value = 1;
    qty.className = 'form-control quantidade-input';

    // botão remover
    const btnRem = document.createElement('button');
    btnRem.type = 'button';
    btnRem.className = 'btn btn-outline-danger';
    btnRem.innerHTML = '<i class="bi bi-dash-circle"></i>';
    btnRem.addEventListener('click', () => row.remove());

    row.append(sel, qty, btnRem);
    document.getElementById('itens-container').append(row);

    // popula o select
    fetch('http://localhost:8080/doces', {
      headers: { 'Authorization': AUTH_HEADER }
    })
    .then(r => r.json())
    .then(produtos => {
      sel.innerHTML = '';
      produtos.forEach(p => {
        const o = document.createElement('option');
        o.value = p.id;
        o.textContent = `${p.nome} (R$ ${p.preco.toFixed(2)})`;
        sel.append(o);
      });
    });
  }

  // evento de adicionar item
  document.getElementById('add-item').addEventListener('click', novaLinha);
  // já cria uma linha inicial
  novaLinha();

  // submit do form
  document.getElementById('compra-form').addEventListener('submit', async e => {
    e.preventDefault();
    const clienteId = document.getElementById('clienteId').value.trim();
    if (!clienteId) return alert('Informe o ID do cliente');
    const itens = Array.from(document.querySelectorAll('.item-row, .d-flex')).map(row => ({
      produtoId: +row.querySelector('.produto-select').value,
      quantidade: +row.querySelector('.quantidade-input').value
    }));
    const payload = { clienteId, itens };

    try {
      const res = await fetch('http://localhost:8080/compras', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': AUTH_HEADER
        },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      if (res.ok) {
        const data = JSON.parse(txt);
        document.getElementById('resultado').textContent =
          `Compra registrada! ID: ${data.id}\n` + JSON.stringify(data, null, 2);
      } else {
        document.getElementById('resultado').textContent =
          `Erro ${res.status}: ${txt}`;
      }
    } catch (err) {
      document.getElementById('resultado').textContent = `Falha: ${err}`;
    }
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

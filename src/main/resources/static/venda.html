<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registrar Venda</title>
  <style>
    body { font-family:sans-serif; margin:2em; background:#fff; }
    label, input, select, button { display:block; width:100%; margin-bottom:0.5em; }
    .item { display:flex; gap:0.5em; }
    .item select, .item input { flex:1; }
    .item button { flex:0 0 auto; }
    #resultado { white-space:pre-wrap; margin-top:1em; color:green; }
  </style>
</head>
<body>
  <h2>Registrar Cliente & Compra</h2>
  <form id="formVenda">
    <h3>Dados do Cliente</h3>
    <label>Cliente existente
      <select id="clienteExistente">
        <option value="">Novo cliente</option>
      </select>
    </label>
    <label>Nome<input type="text" id="nome"></label>
    <label>E-mail<input type="email" id="email"></label>
    <label>CPF<input type="text" id="cpf"></label>
    <label>Telefone<input type="text" id="telefone"></label>
    <label>Data Nasc<input type="date" id="nasc"></label>

    <h3>Itens da Compra</h3>
    <div id="itens"></div>
    <button type="button" id="addItem">+ Adicionar Item</button>

    <button type="submit">Registrar Venda</button>
  </form>

  <pre id="resultado"></pre>

  <script>
    const API = 'http://localhost:8080';
    const ADMIN_AUTH = 'Basic ' + btoa('funcionario@exemplo.com:senha123');
    const DEFAULT_PW = 'Temp123!';
    let produtos = [];

    async function carregarDoces() {
      const res = await fetch(API + '/doces', {
        headers:{ 'Authorization': ADMIN_AUTH }
      });
      produtos = res.ok ? await res.json() : [];
    }

    async function carregarClientes() {
      const sel = document.getElementById('clienteExistente');
      sel.innerHTML = '<option value="">Novo cliente</option>';
      try {
        const res = await fetch(API + '/usuarios/todos', {
          headers: { 'Authorization': ADMIN_AUTH }
        });
        if (res.ok) {
          const clientes = await res.json();
          clientes.forEach(cli => {
            const opt = document.createElement('option');
            opt.value = cli.id;
            opt.textContent = `${cli.nome} (${cli.email})`;
            sel.append(opt);
          });
        }
      } catch {}
    }

    function novaLinha() {
      if (!produtos.length) return alert('Nenhum doce cadastrado.');
      const div = document.createElement('div');
      div.className = 'item';
      const sel = document.createElement('select');
      produtos.forEach(p=>{
        const o = new Option(`${p.nome} (R$${p.preco.toFixed(2)})`, p.id);
        sel.add(o);
      });
      const qty = document.createElement('input');
      qty.type='number'; qty.min=1; qty.value=1;
      const btn = document.createElement('button');
      btn.type='button'; btn.textContent='–';
      btn.onclick = ()=>div.remove();
      div.append(sel, qty, btn);
      document.getElementById('itens').append(div);
    }

    document.getElementById('addItem').onclick = novaLinha;

    document.getElementById('formVenda').onsubmit = async e => {
      e.preventDefault();
      const out = document.getElementById('resultado');
      out.textContent='';
      let clienteId = document.getElementById('clienteExistente').value;
      let cli;
      try {
        if (!clienteId) {
          // Novo cliente
          const cliente = {
            nome: document.getElementById('nome').value,
            email: document.getElementById('email').value,
            senha: DEFAULT_PW,
            cpf: document.getElementById('cpf').value,
            telefone: document.getElementById('telefone').value,
            dataNascimento: document.getElementById('nasc').value
          };
          let rc = await fetch(API + '/usuarios/criar', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization': ADMIN_AUTH
            },
            body: JSON.stringify(cliente)
          });
          if (!rc.ok) throw new Error(await rc.text());
          cli = await rc.json();
          clienteId = cli.id;
        } else {
          // Cliente já existente
          cli = { id: clienteId };
        }
        let itens = Array.from(
          document.querySelectorAll('#itens .item')
        ).map(div=>({
          produtoId: +div.querySelector('select').value,
          quantidade: +div.querySelector('input').value
        }));
        let authCli = 'Basic '+btoa(cli.email ? cli.email+':'+DEFAULT_PW : 'funcionario@exemplo.com:senha123');
        let rp = await fetch(API + '/compras', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': authCli
          },
          body: JSON.stringify({ clienteId, itens })
        });
        if (!rp.ok) throw new Error(await rp.text());
        let compra = await rp.json();
        out.style.color = 'green';
        out.textContent = `Compra ${compra.id} registrada!` + "\n" + JSON.stringify({cli,compra},null,2);
      } catch(err) {
        out.style.color='red';
        out.textContent = err.message;
      }
    };

    (async ()=>{
      await carregarDoces();
      await carregarClientes();
      novaLinha();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Executar Venda</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h3 class="mb-4 text-center">Registrar Cliente & Compra</h3>
    <form id="venda-form" novalidate>
      <!-- 1) Dados do Cliente -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label" for="clienteNome">Nome</label>
          <input type="text" id="clienteNome" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="clienteEmail">E-mail</label>
          <input type="email" id="clienteEmail" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="clienteCpf">CPF</label>
          <input type="text" id="clienteCpf" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="clienteTel">Telefone</label>
          <input type="text" id="clienteTel" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label" for="clienteNasc">Data Nasc.</label>
          <input type="date" id="clienteNasc" class="form-control">
        </div>
      </div>

      <!-- 2) Itens da Compra -->
      <div id="itens-container" class="mb-3"></div>
      <button type="button" id="add-item" class="btn btn-sm btn-secondary mb-4">
        <i class="bi bi-plus-circle"></i> Adicionar Item
      </button>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">
          Registrar Venda
        </button>
      </div>
    </form>

    <pre id="resultado" class="mt-4 text-danger"></pre>
  </div>

  <script>
    const AUTH_ADMIN = 'Basic ' + btoa('funcionario@exemplo.com:senha123');
    const DEFAULT_PASS = 'Temp123!';
    let authCliente;
    let docesDisponiveis = [];

    // Carrega doces uma vez ao iniciar a página
    async function carregarDoces() {
      try {
        const resp = await fetch('http://localhost:8080/doces', {
          headers: { 'Authorization': AUTH_ADMIN }
        });
        if (!resp.ok) throw new Error(await resp.text());
        docesDisponiveis = await resp.json();
      } catch (e) {
        alert('Falha ao carregar doces:\n' + e.message);
        docesDisponiveis = [];
      }
    }

    // Cria uma nova linha de item usando a lista já carregada
    function novaLinha() {
      const row = document.createElement('div');
      row.className = 'item-row d-flex gap-2 mb-2';

      const select = document.createElement('select');
      select.className = 'form-select produto-select';
      select.required = true;

      // Preenche o select com os doces já carregados
      select.innerHTML = '';
      docesDisponiveis.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.nome} (R$ ${p.preco.toFixed(2)})`;
        select.append(opt);
      });

      const qty = document.createElement('input');
      qty.type = 'number'; qty.min = 1; qty.value = 1;
      qty.className = 'form-control quantidade-input';

      const btnRem = document.createElement('button');
      btnRem.type = 'button';
      btnRem.className = 'btn btn-outline-danger';
      btnRem.innerHTML = '<i class="bi bi-dash-circle"></i>';
      btnRem.addEventListener('click', () => row.remove());

      row.append(select, qty, btnRem);
      document.getElementById('itens-container').append(row);
    }

    // Inicialização: carrega doces e adiciona a primeira linha
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarDoces();
      novaLinha();
      document.getElementById('add-item').addEventListener('click', novaLinha);
    });

    // Submit do formulário: 1) cria cliente 2) registra compra
    document.getElementById('venda-form').addEventListener('submit', async e => {
      e.preventDefault();
      const log = document.getElementById('resultado');
      log.textContent = '';

      const cliente = {
        nome: document.getElementById('clienteNome').value,
        email: document.getElementById('clienteEmail').value,
        senha: DEFAULT_PASS,
        cpf: document.getElementById('clienteCpf').value,
        telefone: document.getElementById('clienteTel').value,
        dataNascimento: document.getElementById('clienteNasc').value
      };

      try {
        // Cria novo cliente
        const rc = await fetch('http://localhost:8080/usuarios/criar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': AUTH_ADMIN
          },
          body: JSON.stringify(cliente)
        });
        if (!rc.ok) throw new Error('Erro ao criar cliente: ' + await rc.text());
        const clienteCriado = await rc.json();

        // Prepara o header com credenciais do próprio cliente
        authCliente = 'Basic ' + btoa(clienteCriado.email + ':' + DEFAULT_PASS);

        // Monta itens de compra
        const itens = Array.from(
          document.querySelectorAll('#itens-container > .item-row')
        ).map(row => ({
          produtoId: +row.querySelector('.produto-select').value,
          quantidade: +row.querySelector('.quantidade-input').value
        }));

        // Registra a compra
        const rp = await fetch('http://localhost:8080/compras', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': authCliente
          },
          body: JSON.stringify({
            clienteId: clienteCriado.id,
            itens
          })
        });
        if (!rp.ok) throw new Error('Erro ao criar compra: ' + await rp.text());
        const compra = await rp.json();

        log.style.color = 'green';
        log.textContent =
          `✅ Cliente (${clienteCriado.id}) e Compra (${compra.id}) registrados!\n` +
          JSON.stringify({ cliente: clienteCriado, compra }, null, 2);

      } catch (err) {
        log.style.color = 'red';
        log.textContent = err.message;
      }
    });
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>

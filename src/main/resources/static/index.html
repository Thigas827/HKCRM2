<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HKCRM2 - Cadastro e Histórico de Compras</title>
  <link rel="stylesheet" href="minimal.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: url('chucrute.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    body.dark {
      background: #181818 url('chucrute.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #f1f1f1;
    }
    nav { background: #222; color: #fff; padding: 1rem; display: flex; gap: 1rem; }
    nav.dark, nav.dark a { background: #111 !important; color: #ffd700 !important; }
    nav a { color: #fff; text-decoration: none; cursor: pointer; }
    section { display: none; padding: 2rem; max-width: 600px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; margin-top: 2rem; }
    section.active { display: block; }
    section.dark { background: rgba(30,30,30,0.97) !important; color: #f1f1f1; }
    h2 { margin-top: 0; }
    h2.dark { color: #ffd700 !important; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    input, button, select { padding: 0.5rem; font-size: 1rem; }
    input.dark, select.dark, button.dark {
      background: #222;
      color: #ffd700;
      border: 1px solid #ffd700;
    }
    input.dark:focus, select.dark:focus {
      outline: 2px solid #ffd700;
      border-color: #ffd700;
    }
    button.dark {
      background: #ffd700;
      color: #222;
    }
    button.dark:hover {
      background: #ffe066;
      color: #222;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    table.dark, th.dark, td.dark {
      background: #222 !important;
      color: #ffd700 !important;
      border-color: #ffd700 !important;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <nav>
    <a data-target="login">Login</a>
    <a data-target="cadastro">Cadastro Cliente + Compra</a>
    <a data-target="historico">Histórico de Compras</a>
    <a data-target="cadastroDoce">Cadastro de Produto (Doce)</a>
    <a data-target="buscaDoce">Buscar Produto (Doce)</a>
    <button id="toggleTheme" style="margin-left:auto;">Modo Escuro</button>
  </nav>

  <section id="login" class="active">
    <h2>Login (Fachada)</h2>
    <form id="formLogin">
      <input type="email" id="loginEmail" placeholder="E-mail" required>
      <input type="password" id="loginSenha" placeholder="Senha" required>
      <button type="submit">Entrar</button>
    </form>
    <div id="loginMsg"></div>
  </section>

  <section id="cadastro">
    <h2>Cadastro de Cliente e Compra</h2>
    <form id="formCadastro">
      <input type="text" id="nome" placeholder="Nome do Cliente" required>
      <input type="text" id="email" placeholder="E-mail" required autocomplete="off">
      <input type="text" id="endereco" placeholder="Endereço">
      <input type="text" id="telefone" placeholder="Telefone">
      <h3>Itens da Compra</h3>
      <div id="itensCompraSelects"></div>
      <button type="button" id="addDoceSelect">Adicionar Doce</button>
      <button type="submit">Cadastrar Cliente e Compra</button>
    </form>
    <div id="cadastroMsg"></div>
  </section>

  <section id="cadastroDoce">
    <h2>Cadastro de Produto (Doce)</h2>
    <form id="formCadastroDoce">
      <input type="text" id="nomeDoce" placeholder="Nome do Doce" required>
      <input type="number" id="precoDoce" placeholder="Preço (R$)" min="0" step="0.01" required>
      <input type="text" id="saborDoce" placeholder="Sabor" required>
      <input type="number" id="quantidadeDoce" placeholder="Quantidade" min="1" step="1" required>
      <button type="submit">Cadastrar Produto</button>
    </form>
    <div id="cadastroDoceMsg"></div>
  </section>

  <section id="buscaDoce">
    <h2>Buscar Produto (Doce)</h2>
    <form id="formBuscaDoce">
      <input type="text" id="buscaNomeDoce" placeholder="Nome do Doce">
      <button type="submit">Buscar</button>
    </form>
    <table id="tblDoces" class="hidden">
      <thead><tr><th>ID</th><th>Nome</th><th>Preço</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="buscaDoceMsg"></div>
  </section>

  <section id="historico">
    <h2>Histórico de Compras</h2>
    <form id="formHistorico">
      <select id="clienteSelect" required><option value="">Selecione o cliente</option></select>
      <button type="submit">Buscar Compras</button>
    </form>
    <table id="tblHistorico" class="hidden">
      <thead><tr><th>ID</th><th>Data</th><th>Valor Total</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="historicoMsg"></div>
  </section>

  <script>
    const apiUrl = 'http://localhost:8080';
    // Navegação
    document.querySelectorAll('nav a').forEach(link => {
      link.onclick = () => {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(link.getAttribute('data-target')).classList.add('active');
      };
    });

    // Login de fachada
    document.getElementById('formLogin').onsubmit = e => {
      e.preventDefault();
      document.getElementById('loginMsg').textContent = 'Login de fachada realizado!';
      // Mostra as outras seções
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById('cadastro').classList.add('active');
    };

    // --- Cadastro de Produto (Doce) ---
    document.getElementById('formCadastroDoce').onsubmit = async e => {
      e.preventDefault();
      const nome = document.getElementById('nomeDoce').value.trim();
      const preco = parseFloat(document.getElementById('precoDoce').value);
      const sabor = document.getElementById('saborDoce').value.trim();
      const quantidade = parseInt(document.getElementById('quantidadeDoce').value);
      const dto = { nome, preco, sabor, quantidade };
      try {
        const resp = await fetch(apiUrl + '/doces/criar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dto)
        });
        if (!resp.ok) throw new Error(await resp.text());
        document.getElementById('cadastroDoceMsg').textContent = 'Produto cadastrado com sucesso!';
        document.getElementById('formCadastroDoce').reset();
      } catch (err) {
        document.getElementById('cadastroDoceMsg').textContent = 'Erro: ' + err.message;
      }
    };

    // --- Busca de Produto (Doce) ---
    document.getElementById('formBuscaDoce').onsubmit = async e => {
      e.preventDefault();
      const nomeBusca = document.getElementById('buscaNomeDoce').value.trim().toLowerCase();
      try {
        const resp = await fetch(apiUrl + '/doces');
        const doces = await resp.json();
        const tbody = document.querySelector('#tblDoces tbody');
        tbody.innerHTML = '';
        let encontrados = 0;
        doces.forEach(d => {
          if (!nomeBusca || d.nome.toLowerCase().includes(nomeBusca)) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${d.id}</td><td>${d.nome}</td><td>R$ ${parseFloat(d.preco).toFixed(2)}</td>`;
            tbody.appendChild(tr);
            encontrados++;
          }
        });
        document.getElementById('tblDoces').classList.toggle('hidden', encontrados === 0);
        document.getElementById('buscaDoceMsg').textContent = encontrados ? '' : 'Nenhum produto encontrado.';
      } catch (err) {
        document.getElementById('buscaDoceMsg').textContent = 'Erro: ' + err.message;
      }
    };

    // --- Selects dinâmicos de doces no cadastro de compra ---
    let listaDoces = [];
    async function carregarDocesSelect() {
      const resp = await fetch(apiUrl + '/doces');
      listaDoces = await resp.json();
      atualizarSelectsDoces();
    }
    function criarSelectDoce(idx) {
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.gap = '0.5rem';
      const select = document.createElement('select');
      select.name = 'doceSelect';
      listaDoces.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${d.nome} - R$${parseFloat(d.preco).toFixed(2)}`;
        select.appendChild(opt);
      });
      const inputQtd = document.createElement('input');
      inputQtd.type = 'number';
      inputQtd.min = '1';
      inputQtd.value = '1';
      inputQtd.style.width = '60px';
      inputQtd.placeholder = 'Qtd';
      const btnRemover = document.createElement('button');
      btnRemover.type = 'button';
      btnRemover.textContent = 'Remover';
      btnRemover.onclick = () => {
        div.remove();
      };
      div.appendChild(select);
      div.appendChild(inputQtd);
      div.appendChild(btnRemover);
      return div;
    }
    function atualizarSelectsDoces() {
      const container = document.getElementById('itensCompraSelects');
      container.innerHTML = '';
      container.appendChild(criarSelectDoce(0));
    }
    document.getElementById('addDoceSelect').onclick = () => {
      document.getElementById('itensCompraSelects').appendChild(criarSelectDoce(Date.now()));
    };
    carregarDocesSelect();

    // Cadastro de cliente + compra
    document.getElementById('formCadastro').onsubmit = async e => {
      e.preventDefault();
      const cliente = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        endereco: document.getElementById('endereco').value,
        telefone: document.getElementById('telefone').value,
        senha: '123456' // senha padrão para evitar erro no backend
      };
      // Cria cliente
      let resp = await fetch(apiUrl + '/usuarios/criar', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cliente)
      });
      if (!resp.ok) {
        let msg = 'Erro ao cadastrar cliente.';
        try {
          const err = await resp.json();
          if (err && err.message) msg += ' ' + err.message;
        } catch {}
        document.getElementById('cadastroMsg').textContent = msg;
        return;
      }
      const criado = await resp.json();
      // Itens da compra
      const selects = document.querySelectorAll('#itensCompraSelects select');
      const inputsQtd = document.querySelectorAll('#itensCompraSelects input[type="number"]');
      const itens = [];
      selects.forEach((select, idx) => {
        const qtd = parseInt(inputsQtd[idx].value);
        if (qtd > 0) itens.push({ produtoId: parseInt(select.value), quantidade: qtd });
      });
      if (itens.length) {
        resp = await fetch(apiUrl + '/compras', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clienteId: criado.id, itens })
        });
        if (!resp.ok) { document.getElementById('cadastroMsg').textContent = 'Cliente cadastrado, mas erro ao registrar compra.'; return; }
        document.getElementById('cadastroMsg').textContent = 'Cliente e compra cadastrados com sucesso!';
      } else {
        document.getElementById('cadastroMsg').textContent = 'Cliente cadastrado (sem compra).';
      }
      e.target.reset();
      carregarDocesSelect();
    };

    // Preencher select de clientes no histórico
    async function preencherClientesHistorico() {
      const resp = await fetch(apiUrl + '/usuarios/todos');
      const clientes = await resp.json();
      const select = document.getElementById('clienteSelect');
      select.innerHTML = '<option value="">Selecione o cliente</option>';
      clientes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.nome} (${c.email})`;
        select.appendChild(opt);
      });
    }
    // Carregar clientes ao abrir aba histórico
    document.querySelector('a[data-target="historico"]').addEventListener('click', preencherClientesHistorico);

    // Histórico de compras
    document.getElementById('formHistorico').onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('clienteSelect').value;
      if (!id) return;
      const resp = await fetch(apiUrl + `/compras?clienteId=${id}`);
      const compras = await resp.json();
      const tbody = document.querySelector('#tblHistorico tbody');
      tbody.innerHTML = '';
      if (!compras.length) {
        document.getElementById('tblHistorico').classList.add('hidden');
        document.getElementById('historicoMsg').textContent = 'Nenhuma compra encontrada.';
        return;
      }
      document.getElementById('tblHistorico').classList.remove('hidden');
      document.getElementById('historicoMsg').textContent = '';
      compras.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.id}</td><td>${new Date(c.dataCompra).toLocaleString()}</td><td>${c.valorTotal.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    };

    // Alternância de tema
    const themeBtn = document.getElementById('toggleTheme');
    let darkMode = false;
    function setTheme(dark) {
      darkMode = dark;
      document.body.classList.toggle('dark', dark);
      document.querySelectorAll('nav').forEach(e => e.classList.toggle('dark', dark));
      document.querySelectorAll('section').forEach(e => e.classList.toggle('dark', dark));
      document.querySelectorAll('h2').forEach(e => e.classList.toggle('dark', dark));
      document.querySelectorAll('input,select,button').forEach(e => e.classList.toggle('dark', dark));
      document.querySelectorAll('table,th,td').forEach(e => e.classList.toggle('dark', dark));
      themeBtn.textContent = dark ? 'Modo Claro' : 'Modo Escuro';
    }
    themeBtn.onclick = () => setTheme(!darkMode);
  </script>
</body>
</html>

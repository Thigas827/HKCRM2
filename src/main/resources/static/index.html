<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HKCRM2 - Cadastro e Histórico de Compras</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    nav { background: #222; color: #fff; padding: 1rem; display: flex; gap: 1rem; }
    nav a { color: #fff; text-decoration: none; cursor: pointer; }
    section { display: none; padding: 2rem; max-width: 600px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; margin-top: 2rem; }
    section.active { display: block; }
    h2 { margin-top: 0; }
    form { display: flex; flex-direction: column; gap: 1rem; }
    input, button, select { padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <nav>
    <a data-target="login">Login</a>
    <a data-target="cadastro">Cadastro Cliente + Compra</a>
    <a data-target="historico">Histórico de Compras</a>
  </nav>

  <section id="login" class="active">
    <h2>Login (Fachada)</h2>
    <form id="formLogin">
      <input type="email" id="loginEmail" placeholder="E-mail" required>
      <input type="password" id="loginSenha" placeholder="Senha" required>
      <button type="submit">Entrar</button>
    </form>
    <div id="loginMsg"></div>
  </section>

  <section id="cadastro">
    <h2>Cadastro de Cliente e Compra</h2>
    <form id="formCadastro">
      <input type="text" id="nome" placeholder="Nome do Cliente" required>
      <input type="text" id="email" placeholder="E-mail" required autocomplete="off">
      <input type="text" id="endereco" placeholder="Endereço">
      <input type="text" id="telefone" placeholder="Telefone">
      <h3>Itens da Compra</h3>
      <div id="itensCompra" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
      <button type="submit">Cadastrar Cliente e Compra</button>
    </form>
    <div id="cadastroMsg"></div>
  </section>

  <section id="historico">
    <h2>Histórico de Compras</h2>
    <form id="formHistorico">
      <select id="clienteSelect" required><option value="">Selecione o cliente</option></select>
      <button type="submit">Buscar Compras</button>
    </form>
    <table id="tblHistorico" class="hidden">
      <thead><tr><th>ID</th><th>Data</th><th>Valor Total</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="historicoMsg"></div>
  </section>

  <script>
    const apiUrl = 'http://localhost:8080';
    // Navegação
    document.querySelectorAll('nav a').forEach(link => {
      link.onclick = () => {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(link.dataset.target).classList.add('active');
      };
    });

    // Login de fachada
    document.getElementById('formLogin').onsubmit = e => {
      e.preventDefault();
      document.getElementById('loginMsg').textContent = 'Login de fachada realizado!';
      // Mostra as outras seções
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById('cadastro').classList.add('active');
    };

    // Carregar doces para seleção de compra
    async function carregarDoces() {
      const resp = await fetch(apiUrl + '/doces');
      const doces = await resp.json();
      const div = document.getElementById('itensCompra');
      div.innerHTML = '';
      doces.forEach(d => {
        const linha = document.createElement('div');
        linha.style.display = 'flex';
        linha.style.alignItems = 'center';
        linha.style.gap = '0.5rem';
        linha.innerHTML = `<span>${d.nome} (${d.sabor}) - R$${d.preco}</span> <input type="number" min="0" value="0" data-id="${d.id}" style="width:60px">`;
        div.appendChild(linha);
      });
    }
    carregarDoces();

    // Cadastro de cliente + compra
    document.getElementById('formCadastro').onsubmit = async e => {
      e.preventDefault();
      const cliente = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        endereco: document.getElementById('endereco').value,
        telefone: document.getElementById('telefone').value,
        senha: '123456' // senha padrão para evitar erro no backend
      };
      // Cria cliente
      let resp = await fetch(apiUrl + '/usuarios/criar', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cliente)
      });
      if (!resp.ok) {
        let msg = 'Erro ao cadastrar cliente.';
        try {
          const err = await resp.json();
          if (err && err.message) msg += ' ' + err.message;
        } catch {}
        document.getElementById('cadastroMsg').textContent = msg;
        return;
      }
      const criado = await resp.json();
      // Itens da compra
      const inputs = document.querySelectorAll('#itensCompra input');
      const itens = [];
      inputs.forEach(i => { const qtd = parseInt(i.value); if (qtd > 0) itens.push({ produtoId: parseInt(i.dataset.id), quantidade: qtd }); });
      if (itens.length) {
        resp = await fetch(apiUrl + '/compras', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clienteId: criado.id, itens })
        });
        if (!resp.ok) { document.getElementById('cadastroMsg').textContent = 'Cliente cadastrado, mas erro ao registrar compra.'; return; }
        document.getElementById('cadastroMsg').textContent = 'Cliente e compra cadastrados com sucesso!';
      } else {
        document.getElementById('cadastroMsg').textContent = 'Cliente cadastrado (sem compra).';
      }
      e.target.reset();
      carregarDoces();
    };

    // Preencher select de clientes no histórico
    async function preencherClientesHistorico() {
      const resp = await fetch(apiUrl + '/usuarios/todos');
      const clientes = await resp.json();
      const select = document.getElementById('clienteSelect');
      select.innerHTML = '<option value="">Selecione o cliente</option>';
      clientes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.nome} (${c.email})`;
        select.appendChild(opt);
      });
    }
    // Carregar clientes ao abrir aba histórico
    document.querySelector('a[data-target="historico"]').addEventListener('click', preencherClientesHistorico);

    // Histórico de compras
    document.getElementById('formHistorico').onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('clienteSelect').value;
      if (!id) return;
      const resp = await fetch(apiUrl + `/compras?clienteId=${id}`);
      const compras = await resp.json();
      const tbody = document.querySelector('#tblHistorico tbody');
      tbody.innerHTML = '';
      if (!compras.length) {
        document.getElementById('tblHistorico').classList.add('hidden');
        document.getElementById('historicoMsg').textContent = 'Nenhuma compra encontrada.';
        return;
      }
      document.getElementById('tblHistorico').classList.remove('hidden');
      document.getElementById('historicoMsg').textContent = '';
      compras.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.id}</td><td>${new Date(c.dataCompra).toLocaleString()}</td><td>${c.valorTotal.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    };
  </script>
</body>
</html>
